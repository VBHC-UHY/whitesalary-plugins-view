<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™½çš„æ’ä»¶å¸‚åœº - åœ¨çº¿æµè§ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Noto Sans SC', sans-serif; }
        
        html, body {
            height: 100%;
            overflow: hidden;
        }
        
        body {
            background: linear-gradient(180deg, #fdf4ff 0%, #faf5ff 30%, #f5f3ff 60%, #ede9fe 100%);
        }
        
        .hero-gradient {
            background: linear-gradient(135deg, #a855f7 0%, #ec4899 50%, #f472b6 100%);
        }
        
        .main-container {
            height: calc(100vh - 70px);
            display: flex;
        }
        
        .sidebar {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(168, 85, 247, 0.08);
            overflow-y: auto;
            height: 100%;
        }
        .sidebar::-webkit-scrollbar { width: 4px; }
        .sidebar::-webkit-scrollbar-thumb { background: #e9d5ff; border-radius: 4px; }
        
        .content-area {
            overflow-y: auto;
            height: 100%;
            padding-right: 8px;
        }
        .content-area::-webkit-scrollbar { width: 6px; }
        .content-area::-webkit-scrollbar-thumb { background: #d8b4fe; border-radius: 6px; }
        
        .cat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 4px;
        }
        
        .cat-group-title {
            grid-column: span 2;
            font-size: 11px;
            font-weight: 600;
            color: #9333ea;
            padding: 10px 8px 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: #faf5ff;
            border-radius: 8px;
            margin-top: 6px;
        }
        .cat-group-title:first-child { margin-top: 0; }
        
        .cat-item {
            padding: 8px 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #6b7280;
            transition: all 0.2s ease;
            border-radius: 8px;
            white-space: nowrap;
        }
        .cat-item:hover { background: #faf5ff; color: #7c3aed; }
        .cat-item.active {
            background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
            color: white;
        }
        .cat-item.full-width { grid-column: span 2; }
        
        .search-input {
            width: 100%;
            padding: 14px 20px 14px 52px;
            border-radius: 16px;
            border: 2px solid #e9d5ff;
            background: white;
            font-size: 15px;
            transition: all 0.3s ease;
        }
        .search-input:focus {
            outline: none;
            border-color: #a855f7;
            box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
        }
        .search-input::placeholder { color: #c4b5fd; }
        
        .plugin-card {
            background: white;
            border-radius: 16px;
            padding: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(168, 85, 247, 0.1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            position: relative;
        }
        .plugin-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 30px rgba(168, 85, 247, 0.15);
        }
        
        .featured-card {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border: 2px solid #fbbf24;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 12px 20px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(168, 85, 247, 0.4);
        }
        
        .tag-btn {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
        }
        .tag-btn:hover { transform: scale(1.05); }
        .tag-btn.active { box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        
        .new-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            background: #ef4444;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .screenshot-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        .screenshot-item {
            aspect-ratio: 16/10;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            border: 1px solid #e5e7eb;
            transition: all 0.2s;
        }
        .screenshot-item:hover {
            border-color: #a855f7;
            transform: scale(1.02);
        }
        .screenshot-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨ -->
    <div class="hero-gradient text-white">
        <div class="px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="text-4xl">ğŸª</div>
                    <div>
                        <h1 class="text-2xl font-black">ç™½çš„æ’ä»¶å¸‚åœº</h1>
                        <p class="text-white/80 text-sm">åœ¨çº¿æµè§ˆç‰ˆ</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <div class="stat-card flex items-center gap-2">
                        <span>ğŸ“¦</span>
                        <span class="font-bold" id="stat-total">-</span>
                        <span class="text-sm text-white/70">æ’ä»¶</span>
                    </div>
                    <div class="stat-card flex items-center gap-2">
                        <span>â­</span>
                        <span class="font-bold" id="stat-featured">-</span>
                        <span class="text-sm text-white/70">ç²¾é€‰</span>
                    </div>
                    <div class="stat-card flex items-center gap-2">
                        <span>â¬‡ï¸</span>
                        <span class="font-bold" id="stat-downloads">-</span>
                        <span class="text-sm text-white/70">ä¸‹è½½</span>
                    </div>
                </div>
                
                <div class="flex items-center gap-2">
                    <button onclick="goLocal()" class="px-4 py-2 rounded-lg bg-white/20 hover:bg-white/30 transition-all text-sm font-medium">
                        ğŸ  æœ¬åœ°å¸‚åœº
                    </button>
                    <a href="https://whitesalary-plugins-web.vercel.app" target="_blank" class="px-4 py-2 rounded-lg bg-white/20 hover:bg-white/30 transition-all text-sm font-medium">
                        ğŸ“¤ æäº¤æ’ä»¶
                    </a>
                    <a href="https://github.com/VBHC-UHY/whitesalary-plugins" target="_blank" class="px-4 py-2 rounded-lg bg-white/20 hover:bg-white/30 transition-all text-sm font-medium">
                        ğŸ“‚ GitHub
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»ä½“ -->
    <div class="main-container px-6 py-4 gap-6">
        <!-- å·¦ä¾§åˆ†ç±» -->
        <div class="w-72 flex-shrink-0">
            <div class="sidebar p-4">
                <div class="font-bold text-gray-800 mb-3 flex items-center gap-2 sticky top-0 bg-white pb-2 z-10">
                    ğŸ·ï¸ æ’ä»¶åˆ†ç±» <span class="text-xs text-gray-400 font-normal">(28)</span>
                </div>
                
                <div class="cat-grid">
                    <div class="cat-item full-width active" data-cat="" onclick="filterCat('')">
                        <span>ğŸ“‹</span> å…¨éƒ¨æ’ä»¶
                    </div>
                    
                    <div class="cat-group-title">ğŸ¯ æ ¸å¿ƒåŠŸèƒ½</div>
                    <div class="cat-item" data-cat="å¨±ä¹æ¸¸æˆ" onclick="filterCat('å¨±ä¹æ¸¸æˆ')"><span>ğŸ®</span>å¨±ä¹æ¸¸æˆ</div>
                    <div class="cat-item" data-cat="å®ç”¨å·¥å…·" onclick="filterCat('å®ç”¨å·¥å…·')"><span>ğŸ› ï¸</span>å®ç”¨å·¥å…·</div>
                    <div class="cat-item" data-cat="ç¤¾äº¤äº’åŠ¨" onclick="filterCat('ç¤¾äº¤äº’åŠ¨')"><span>ğŸ’¬</span>ç¤¾äº¤äº’åŠ¨</div>
                    <div class="cat-item" data-cat="AIå¢å¼º" onclick="filterCat('AIå¢å¼º')"><span>ğŸ¤–</span>AIå¢å¼º</div>
                    
                    <div class="cat-group-title">ğŸ“º åª’ä½“å†…å®¹</div>
                    <div class="cat-item" data-cat="éŸ³ä¹éŸ³é¢‘" onclick="filterCat('éŸ³ä¹éŸ³é¢‘')"><span>ğŸµ</span>éŸ³ä¹éŸ³é¢‘</div>
                    <div class="cat-item" data-cat="å›¾ç‰‡å¤„ç†" onclick="filterCat('å›¾ç‰‡å¤„ç†')"><span>ğŸ–¼ï¸</span>å›¾ç‰‡å¤„ç†</div>
                    <div class="cat-item" data-cat="è§†é¢‘ç›¸å…³" onclick="filterCat('è§†é¢‘ç›¸å…³')"><span>ğŸ“¹</span>è§†é¢‘ç›¸å…³</div>
                    <div class="cat-item" data-cat="åª’ä½“ç»¼åˆ" onclick="filterCat('åª’ä½“ç»¼åˆ')"><span>ğŸ“º</span>åª’ä½“ç»¼åˆ</div>
                    
                    <div class="cat-group-title">ğŸ“° ä¿¡æ¯èµ„è®¯</div>
                    <div class="cat-item" data-cat="æ–°é—»èµ„è®¯" onclick="filterCat('æ–°é—»èµ„è®¯')"><span>ğŸ“°</span>æ–°é—»èµ„è®¯</div>
                    <div class="cat-item" data-cat="å¤©æ°”æ—¥å†" onclick="filterCat('å¤©æ°”æ—¥å†')"><span>ğŸŒ¤ï¸</span>å¤©æ°”æ—¥å†</div>
                    <div class="cat-item" data-cat="ç½‘ç»œæœç´¢" onclick="filterCat('ç½‘ç»œæœç´¢')"><span>ğŸ”</span>ç½‘ç»œæœç´¢</div>
                    <div class="cat-item" data-cat="ç¿»è¯‘è¯­è¨€" onclick="filterCat('ç¿»è¯‘è¯­è¨€')"><span>ğŸŒ</span>ç¿»è¯‘è¯­è¨€</div>
                    
                    <div class="cat-group-title">âš¡ æ•ˆç‡æå‡</div>
                    <div class="cat-item" data-cat="è‡ªåŠ¨åŒ–" onclick="filterCat('è‡ªåŠ¨åŒ–')"><span>âš¡</span>è‡ªåŠ¨åŒ–</div>
                    <div class="cat-item" data-cat="æé†’å¤‡å¿˜" onclick="filterCat('æé†’å¤‡å¿˜')"><span>â°</span>æé†’å¤‡å¿˜</div>
                    <div class="cat-item" data-cat="æ•°æ®å¤„ç†" onclick="filterCat('æ•°æ®å¤„ç†')"><span>ğŸ“Š</span>æ•°æ®å¤„ç†</div>
                    <div class="cat-item" data-cat="å¼€å‘å·¥å…·" onclick="filterCat('å¼€å‘å·¥å…·')"><span>ğŸ’»</span>å¼€å‘å·¥å…·</div>
                    
                    <div class="cat-group-title">ğŸ² è¶£å‘³ä¼‘é—²</div>
                    <div class="cat-item" data-cat="å åœç®—å‘½" onclick="filterCat('å åœç®—å‘½')"><span>ğŸ”®</span>å åœç®—å‘½</div>
                    <div class="cat-item" data-cat="è¶£å‘³æ¶æ" onclick="filterCat('è¶£å‘³æ¶æ')"><span>ğŸƒ</span>è¶£å‘³æ¶æ</div>
                    <div class="cat-item" data-cat="è§’è‰²æ‰®æ¼”" onclick="filterCat('è§’è‰²æ‰®æ¼”')"><span>ğŸ­</span>è§’è‰²æ‰®æ¼”</div>
                    <div class="cat-item" data-cat="æŠ½å¥–éšæœº" onclick="filterCat('æŠ½å¥–éšæœº')"><span>ğŸ°</span>æŠ½å¥–éšæœº</div>
                    
                    <div class="cat-group-title">ğŸ  ç”Ÿæ´»æœåŠ¡</div>
                    <div class="cat-item" data-cat="ç”Ÿæ´»æœåŠ¡" onclick="filterCat('ç”Ÿæ´»æœåŠ¡')"><span>ğŸ </span>ç”Ÿæ´»æœåŠ¡</div>
                    <div class="cat-item" data-cat="å­¦ä¹ æ•™è‚²" onclick="filterCat('å­¦ä¹ æ•™è‚²')"><span>ğŸ“š</span>å­¦ä¹ æ•™è‚²</div>
                    <div class="cat-item" data-cat="è´¢åŠ¡é‡‘è" onclick="filterCat('è´¢åŠ¡é‡‘è')"><span>ğŸ’°</span>è´¢åŠ¡é‡‘è</div>
                    <div class="cat-item" data-cat="å¥åº·è¿åŠ¨" onclick="filterCat('å¥åº·è¿åŠ¨')"><span>ğŸ’ª</span>å¥åº·è¿åŠ¨</div>
                    
                    <div class="cat-group-title">ğŸ‘¥ ç¾¤ç»„ç®¡ç†</div>
                    <div class="cat-item" data-cat="ç¾¤ç®¡ç†" onclick="filterCat('ç¾¤ç®¡ç†')"><span>ğŸ‘®</span>ç¾¤ç®¡ç†</div>
                    <div class="cat-item" data-cat="æ•°æ®ç»Ÿè®¡" onclick="filterCat('æ•°æ®ç»Ÿè®¡')"><span>ğŸ“ˆ</span>æ•°æ®ç»Ÿè®¡</div>
                    <div class="cat-item" data-cat="ç¾¤äº’åŠ¨" onclick="filterCat('ç¾¤äº’åŠ¨')"><span>ğŸ‰</span>ç¾¤äº’åŠ¨</div>
                    
                    <div class="cat-group-title">ğŸ”§ å…¶ä»–</div>
                    <div class="cat-item" data-cat="ç³»ç»Ÿç®¡ç†" onclick="filterCat('ç³»ç»Ÿç®¡ç†')"><span>âš™ï¸</span>ç³»ç»Ÿç®¡ç†</div>
                    <div class="cat-item" data-cat="å…¶ä»–" onclick="filterCat('å…¶ä»–')"><span>ğŸ“¦</span>å…¶ä»–</div>
                </div>
            </div>
        </div>
        
        <!-- å³ä¾§å†…å®¹ -->
        <div class="flex-1 min-w-0 content-area">
            <!-- æœç´¢æ¡† -->
            <div class="bg-white rounded-2xl p-4 mb-4 shadow-sm">
                <div class="relative">
                    <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    <input type="text" id="searchInput" placeholder="âœ¨ æœç´¢æ’ä»¶åç§°ã€æè¿°ã€ä½œè€…..." class="search-input">
                </div>
                
                <!-- æ’åº + æ ‡ç­¾ç­›é€‰ -->
                <div class="flex items-center gap-3 mt-3 flex-wrap">
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-gray-500">ğŸ“ˆ æ’åº:</span>
                        <select id="sortSelect" onchange="sortChange(this.value)" class="px-3 py-1.5 rounded-lg border border-gray-200 text-sm bg-white focus:border-purple-400 focus:ring-1 focus:ring-purple-200">
                            <option value="default">é»˜è®¤</option>
                            <option value="downloads_desc">ä¸‹è½½é‡â†“</option>
                            <option value="downloads_asc">ä¸‹è½½é‡â†‘</option>
                            <option value="rating_desc">è¯„åˆ†â†“</option>
                            <option value="rating_asc">è¯„åˆ†â†‘</option>
                            <option value="name_asc">åç§°A-Z</option>
                            <option value="name_desc">åç§°Z-A</option>
                        </select>
                    </div>
                    <span class="text-gray-300">|</span>
                    <span class="text-xs text-gray-400">å¿«é€Ÿç­›é€‰:</span>
                    <button onclick="filterTag('all')" id="tag-all" class="tag-btn bg-gray-100 text-gray-600 active">å…¨éƒ¨</button>
                    <button onclick="filterTag('free')" id="tag-free" class="tag-btn bg-green-50 text-green-600">ğŸ†“ å…è´¹</button>
                    <button onclick="filterTag('hot')" id="tag-hot" class="tag-btn bg-red-50 text-red-600">ğŸ”¥ çƒ­é—¨</button>
                    <button onclick="filterTag('new')" id="tag-new" class="tag-btn bg-blue-50 text-blue-600">âœ¨ æ–°å“</button>
                    <button onclick="filterTag('featured')" id="tag-featured" class="tag-btn bg-amber-50 text-amber-600">â­ ç²¾é€‰</button>
                    <button onclick="filterTag('highrated')" id="tag-highrated" class="tag-btn bg-purple-50 text-purple-600">ğŸ’ é«˜è¯„åˆ†</button>
                    <button onclick="filterTag('favorites')" id="tag-favorites" class="tag-btn bg-pink-50 text-pink-600">â¤ï¸ æ”¶è—</button>
                </div>
            </div>

            <!-- ç²¾é€‰ -->
            <div id="featuredArea" class="mb-5 hidden">
                <h2 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">â­ ç²¾é€‰æ¨è</h2>
                <div id="featuredList" class="grid grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-4"></div>
            </div>

            <!-- æ‰€æœ‰æ’ä»¶ -->
            <div>
                <h2 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                    ğŸ“¦ <span id="catTitle">æ‰€æœ‰æ’ä»¶</span> 
                    <span class="text-gray-400 font-normal text-sm" id="countText"></span>
                </h2>
                <div id="pluginList" class="grid grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-4">
                    <div class="col-span-full text-center py-12">
                        <div class="text-4xl mb-3">â³</div>
                        <p class="text-gray-500">æ­£åœ¨åŠ è½½æ’ä»¶...</p>
                    </div>
                </div>
            </div>
            
            <div class="h-4"></div>
        </div>
    </div>

    <!-- æ’ä»¶è¯¦æƒ…å¼¹çª— -->
    <div id="modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4 hidden" onclick="if(event.target===this)closeModal()">
        <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[85vh] overflow-hidden shadow-2xl">
            <div id="modalHeader" class="p-5 bg-gradient-to-r from-purple-50 to-pink-50 border-b"></div>
            <div id="modalBody" class="p-5 overflow-y-auto" style="max-height: calc(85vh - 180px);"></div>
            <div class="p-4 border-t bg-gray-50 flex items-center justify-between">
                <a id="modalGithub" href="#" target="_blank" class="text-purple-600 hover:text-purple-800 text-sm flex items-center gap-1">ğŸ“‚ æŸ¥çœ‹æºä»£ç </a>
                <div class="flex gap-2">
                    <button onclick="closeModal()" class="px-4 py-2 rounded-lg border border-gray-200 text-gray-600 hover:bg-gray-100 text-sm">å…³é—­</button>
                    <button onclick="installPlugin()" class="btn-primary px-4 py-2 rounded-lg text-white text-sm">ğŸ”— å‰å¾€å®‰è£…</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æˆªå›¾æ”¾å¤§å¼¹çª— -->
    <div id="screenshotModal" class="fixed inset-0 bg-black/90 flex items-center justify-center z-[60] p-4 hidden" onclick="closeScreenshot()">
        <img id="screenshotImg" src="" class="max-w-full max-h-[90vh] rounded-lg shadow-2xl" onclick="event.stopPropagation()">
        <button onclick="closeScreenshot()" class="absolute top-4 right-4 w-10 h-10 bg-white rounded-full shadow-lg flex items-center justify-center text-gray-600 hover:bg-gray-100">
            âœ•
        </button>
    </div>

    <script>
        const GITHUB_RAW = 'https://raw.githubusercontent.com/VBHC-UHY/whitesalary-plugins/main/plugins.json';
        const GITHUB_REPO = 'https://github.com/VBHC-UHY/whitesalary-plugins/tree/main/plugins/';
        const LOCAL_URL = 'http://127.0.0.1:5266';
        
        let plugins = [];
        let currentPlugin = null;
        let currentCat = '';
        let currentTag = 'all';
        let sortBy = 'default';  // æ’åºæ–¹å¼
        let selectedAuthor = '';  // ä½œè€…ç­›é€‰
        let myRatings = {};
        let viewedVersions = {};  // å·²æŸ¥çœ‹çš„æ’ä»¶ç‰ˆæœ¬ {pluginId: version}
        let favorites = [];  // æ”¶è—åˆ—è¡¨
        
        // åˆ†ç±»å›¾æ ‡
        const icons = {
            'å¨±ä¹æ¸¸æˆ': 'ğŸ®', 'å®ç”¨å·¥å…·': 'ğŸ› ï¸', 'ç¤¾äº¤äº’åŠ¨': 'ğŸ’¬', 'AIå¢å¼º': 'ğŸ¤–',
            'éŸ³ä¹éŸ³é¢‘': 'ğŸµ', 'å›¾ç‰‡å¤„ç†': 'ğŸ–¼ï¸', 'è§†é¢‘ç›¸å…³': 'ğŸ“¹', 'åª’ä½“ç»¼åˆ': 'ğŸ“º',
            'æ–°é—»èµ„è®¯': 'ğŸ“°', 'å¤©æ°”æ—¥å†': 'ğŸŒ¤ï¸', 'ç½‘ç»œæœç´¢': 'ğŸ”', 'ç¿»è¯‘è¯­è¨€': 'ğŸŒ',
            'è‡ªåŠ¨åŒ–': 'âš¡', 'æé†’å¤‡å¿˜': 'â°', 'æ•°æ®å¤„ç†': 'ğŸ“Š', 'å¼€å‘å·¥å…·': 'ğŸ’»',
            'å åœç®—å‘½': 'ğŸ”®', 'è¶£å‘³æ¶æ': 'ğŸƒ', 'è§’è‰²æ‰®æ¼”': 'ğŸ­', 'æŠ½å¥–éšæœº': 'ğŸ°',
            'ç”Ÿæ´»æœåŠ¡': 'ğŸ ', 'å­¦ä¹ æ•™è‚²': 'ğŸ“š', 'è´¢åŠ¡é‡‘è': 'ğŸ’°', 'å¥åº·è¿åŠ¨': 'ğŸ’ª',
            'ç¾¤ç®¡ç†': 'ğŸ‘®', 'æ•°æ®ç»Ÿè®¡': 'ğŸ“ˆ', 'ç¾¤äº’åŠ¨': 'ğŸ‰', 'ç³»ç»Ÿç®¡ç†': 'âš™ï¸', 'å…¶ä»–': 'ğŸ“¦'
        };
        
        // ========== å·²æŸ¥çœ‹ç‰ˆæœ¬ç®¡ç† ==========
        function loadViewedVersions() {
            try {
                const saved = localStorage.getItem('plugin_viewed_versions');
                if (saved) viewedVersions = JSON.parse(saved);
            } catch (e) { viewedVersions = {}; }
        }
        
        function saveViewedVersions() {
            try {
                localStorage.setItem('plugin_viewed_versions', JSON.stringify(viewedVersions));
            } catch (e) {}
        }
        
        // æ ‡è®°æ’ä»¶ä¸ºå·²æŸ¥çœ‹ï¼ˆè®°å½•å½“å‰ç‰ˆæœ¬ï¼‰
        function markAsViewed(pluginId, version) {
            viewedVersions[pluginId] = version;
            saveViewedVersions();
        }
        
        // æ£€æŸ¥æ’ä»¶æ˜¯å¦æœ‰"æ–°"å†…å®¹ï¼ˆç‰ˆæœ¬æ¯”å·²æŸ¥çœ‹çš„æ–°ï¼‰
        function isNewForUser(plugin) {
            if (!plugin) return false;
            const viewedVer = viewedVersions[plugin.id];
            // å¦‚æœä»æœªæŸ¥çœ‹è¿‡ï¼Œå°±æ˜¯æ–°çš„
            if (!viewedVer) return true;
            // å¦‚æœå½“å‰ç‰ˆæœ¬æ¯”å·²æŸ¥çœ‹ç‰ˆæœ¬æ–°ï¼Œå°±æ˜¯æ–°çš„
            return compareVersions(plugin.version, viewedVer) > 0;
        }
        
        // æ¯”è¾ƒç‰ˆæœ¬å·
        function compareVersions(v1, v2) {
            if (!v1 || !v2) return 0;
            const p1 = v1.split('.').map(n => parseInt(n) || 0);
            const p2 = v2.split('.').map(n => parseInt(n) || 0);
            for (let i = 0; i < Math.max(p1.length, p2.length); i++) {
                const a = p1[i] || 0, b = p2[i] || 0;
                if (a > b) return 1;
                if (a < b) return -1;
            }
            return 0;
        }
        
        // ========== è¯„åˆ†ç³»ç»Ÿ ==========
        function loadMyRatings() {
            try {
                const saved = localStorage.getItem('plugin_my_ratings_view');
                if (saved) myRatings = JSON.parse(saved);
            } catch (e) { myRatings = {}; }
        }
        
        function saveMyRatings() {
            try {
                localStorage.setItem('plugin_my_ratings_view', JSON.stringify(myRatings));
            } catch (e) {}
        }
        
        function getMyRating(pluginId) {
            return myRatings[pluginId] || 0;
        }
        
        function ratePlugin(pluginId, rating, event) {
            if (event) event.stopPropagation();
            if (!pluginId) return;
            
            if (myRatings[pluginId] === rating) {
                delete myRatings[pluginId];
                showToast('å·²å–æ¶ˆè¯„åˆ†');
            } else {
                myRatings[pluginId] = rating;
                showToast('å·²è¯„åˆ† ' + rating + ' æ˜Ÿ â­');
            }
            saveMyRatings();
            if (currentPlugin) showDetail(currentPlugin.id);
        }
        
        function renderStars(rating, interactive, pluginId) {
            let html = '';
            const filled = Math.round(rating || 5);
            for (let i = 1; i <= 5; i++) {
                if (interactive) {
                    const myR = getMyRating(pluginId);
                    const isActive = myR ? i <= myR : i <= filled;
                    html += `<button onclick="ratePlugin('${pluginId}',${i},event)" 
                            class="text-lg transition-transform hover:scale-125 focus:outline-none ${isActive ? 'text-amber-400' : 'text-gray-300'}">â˜…</button>`;
                } else {
                    html += `<span class="text-sm ${i <= filled ? 'text-amber-400' : 'text-gray-300'}">â˜…</span>`;
                }
            }
            return html;
        }
        
        function showToast(msg) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg z-[100] text-sm';
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }
        
        // ========== ä½œè€…ç­›é€‰ ==========
        function filterByAuthor(author) {
            selectedAuthor = author;
            currentCat = '';
            currentTag = 'all';
            document.getElementById('searchInput').value = '';
            document.querySelectorAll('.cat-item').forEach(item => {
                item.classList.toggle('active', item.dataset.cat === '');
            });
            render();
            renderFeatured();
            showToast('ğŸ‘¤ æ˜¾ç¤º ' + author + ' çš„æ‰€æœ‰æ’ä»¶');
        }
        
        function clearAuthorFilter() {
            selectedAuthor = '';
            render();
            renderFeatured();
        }
        
        function getAuthorPluginCount(author) {
            return plugins.filter(p => p.author === author).length;
        }
        
        // ========== æ”¶è—åŠŸèƒ½ ==========
        function loadFavorites() {
            try {
                const saved = localStorage.getItem('plugin_favorites_view');
                if (saved) favorites = JSON.parse(saved);
            } catch (e) { favorites = []; }
        }
        
        function saveFavorites() {
            try {
                localStorage.setItem('plugin_favorites_view', JSON.stringify(favorites));
            } catch (e) {}
        }
        
        function isFavorite(pluginId) {
            return favorites.includes(pluginId);
        }
        
        function toggleFavorite(pluginId, event) {
            if (event) event.stopPropagation();
            if (!pluginId) return;
            
            if (isFavorite(pluginId)) {
                favorites = favorites.filter(id => id !== pluginId);
                showToast('å·²å–æ¶ˆæ”¶è—');
            } else {
                favorites.push(pluginId);
                showToast('â¤ï¸ å·²æ”¶è—');
            }
            saveFavorites();
            render();
            renderFeatured();
        }
        
        function getFavoritesCount() {
            return favorites.length;
        }
        
        // ========== æ’åºåŠŸèƒ½ ==========
        function sortChange(value) {
            sortBy = value;
            render();
            renderFeatured();
        }
        
        function sortPluginList(list) {
            if (sortBy === 'default') return list;
            
            return [...list].sort((a, b) => {
                switch (sortBy) {
                    case 'downloads_desc':
                        return (b.downloads || 0) - (a.downloads || 0);
                    case 'downloads_asc':
                        return (a.downloads || 0) - (b.downloads || 0);
                    case 'rating_desc':
                        return (b.rating || 5) - (a.rating || 5);
                    case 'rating_asc':
                        return (a.rating || 5) - (b.rating || 5);
                    case 'name_asc':
                        return (a.cn_name || a.name || '').localeCompare(b.cn_name || b.name || '', 'zh-CN');
                    case 'name_desc':
                        return (b.cn_name || b.name || '').localeCompare(a.cn_name || a.name || '', 'zh-CN');
                    default:
                        return 0;
                }
            });
        }
        
        // ========== æ ‡ç­¾ç­›é€‰ ==========
        function filterTag(tag) {
            currentTag = tag;
            document.querySelectorAll('.tag-btn').forEach(btn => {
                btn.classList.toggle('active', btn.id === 'tag-' + tag);
                btn.classList.toggle('ring-2', btn.id === 'tag-' + tag);
                btn.classList.toggle('ring-offset-1', btn.id === 'tag-' + tag);
            });
            render();
        }
        
        function matchTag(plugin, tag) {
            switch (tag) {
                case 'all': return true;
                case 'free': return !plugin.price || plugin.price === 0;
                case 'hot': return (plugin.downloads || 0) >= 100;
                case 'new': return isNewForUser(plugin);  // ç”¨æˆ·æœªæŸ¥çœ‹è¿‡æ­¤ç‰ˆæœ¬
                case 'featured': return plugin.featured === true;
                case 'highrated': return (plugin.rating || 5) >= 4.5;
                case 'favorites': return isFavorite(plugin.id);
                default: return true;
            }
        }
        
        // ========== åˆ†ç±»ç­›é€‰ ==========
        function filterCat(cat) {
            currentCat = cat;
            document.querySelectorAll('.cat-item').forEach(item => {
                item.classList.toggle('active', item.dataset.cat === cat);
            });
            document.getElementById('catTitle').textContent = cat ? (icons[cat] || 'ğŸ“¦') + ' ' + cat : 'æ‰€æœ‰æ’ä»¶';
            render();
        }
        
        // ========== æˆªå›¾åŠŸèƒ½ ==========
        function showScreenshot(url) {
            document.getElementById('screenshotImg').src = url;
            document.getElementById('screenshotModal').classList.remove('hidden');
        }
        
        function closeScreenshot() {
            document.getElementById('screenshotModal').classList.add('hidden');
        }
        
        // ========== åˆå§‹åŒ– ==========
        async function init() {
            loadMyRatings();
            loadViewedVersions();
            loadFavorites();
            try {
                let data;
                try {
                    const apiRes = await fetch('/api/plugins');
                    if (apiRes.ok) {
                        data = await apiRes.json();
                        if (data.success) {
                            plugins = data.plugins || [];
                        } else {
                            throw new Error('APIè¿”å›å¤±è´¥');
                        }
                    } else {
                        throw new Error('APIä¸å¯ç”¨');
                    }
                } catch (apiErr) {
                    console.log('APIä»£ç†ä¸å¯ç”¨ï¼Œå›é€€åˆ°GitHub Raw:', apiErr.message);
                    const rawRes = await fetch(GITHUB_RAW + '?t=' + Date.now());
                    if (!rawRes.ok) throw new Error('HTTP ' + rawRes.status);
                    data = await rawRes.json();
                    plugins = data.plugins || [];
                }
                
                // ç»Ÿè®¡
                const totalDownloads = plugins.reduce((sum, p) => sum + (p.downloads || 0), 0);
                document.getElementById('stat-total').textContent = plugins.length;
                document.getElementById('stat-featured').textContent = plugins.filter(p => p.featured).length;
                document.getElementById('stat-downloads').textContent = totalDownloads >= 1000 ? (totalDownloads / 1000).toFixed(1) + 'k' : totalDownloads;
                
                render();
                renderFeatured();
            } catch (err) {
                document.getElementById('pluginList').innerHTML = 
                    '<div class="col-span-full text-center py-12">' +
                    '<div class="text-4xl mb-3">ğŸ˜¢</div>' +
                    '<p class="text-gray-500">åŠ è½½å¤±è´¥: ' + err.message + '</p></div>';
            }
        }
        
        function renderFeatured() {
            const featured = plugins.filter(p => p.featured);
            const area = document.getElementById('featuredArea');
            const list = document.getElementById('featuredList');
            if (featured.length === 0 || currentCat || currentTag !== 'all') { 
                area.classList.add('hidden'); 
                return; 
            }
            area.classList.remove('hidden');
            list.innerHTML = featured.map(p => makeCard(p, true)).join('');
        }
        
        function render() {
            const search = (document.getElementById('searchInput')?.value || '').toLowerCase();
            let list = plugins;
            
            // æœç´¢
            if (search) {
                list = list.filter(p => 
                    (p.cn_name || '').toLowerCase().includes(search) ||
                    (p.name || '').toLowerCase().includes(search) ||
                    (p.description || '').toLowerCase().includes(search) ||
                    (p.author || '').toLowerCase().includes(search)
                );
            }
            
            // åˆ†ç±»
            if (currentCat) {
                list = list.filter(p => p.category === currentCat);
            }
            
            // æ ‡ç­¾
            if (currentTag !== 'all') {
                list = list.filter(p => matchTag(p, currentTag));
            }
            
            // ä½œè€…
            if (selectedAuthor) {
                list = list.filter(p => p.author === selectedAuthor);
            }
            
            // åº”ç”¨æ’åº
            list = sortPluginList(list);
            
            document.getElementById('countText').textContent = '(' + list.length + 'ä¸ª)';
            
            // éšè—/æ˜¾ç¤ºç²¾é€‰
            const featuredArea = document.getElementById('featuredArea');
            if (search || currentCat || currentTag !== 'all') {
                featuredArea.classList.add('hidden');
            } else {
                renderFeatured();
            }
            
            const container = document.getElementById('pluginList');
            if (list.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center py-12">' +
                    '<div class="text-4xl mb-3">ğŸ”</div>' +
                    '<p class="text-gray-500">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ’ä»¶</p></div>';
                return;
            }
            container.innerHTML = list.map(p => makeCard(p)).join('');
        }
        
        function makeCard(p, featured) {
            const icon = icons[p.category] || 'ğŸ“¦';
            const isNew = isNewForUser(p);  // ç”¨æˆ·æœªæŸ¥çœ‹è¿‡æ­¤ç‰ˆæœ¬
            const isHot = (p.downloads || 0) >= 100;
            
            return `<div onclick="showDetail('${p.id}')" class="plugin-card cursor-pointer ${featured ? 'featured-card' : ''}" style="position:relative">
                ${isNew ? '<span class="new-badge">NEW</span>' : ''}
                <button onclick="event.stopPropagation(); toggleFavorite('${p.id}', event)" 
                        class="absolute top-2 right-2 w-7 h-7 rounded-full flex items-center justify-center transition-all ${isFavorite(p.id) ? 'bg-pink-100 text-pink-500' : 'bg-gray-100 text-gray-400 hover:bg-pink-50'}">
                    ${isFavorite(p.id) ? 'â¤ï¸' : 'ğŸ¤'}
                </button>
                <div class="flex items-start gap-3 mb-2 pr-8">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-purple-100 to-pink-100 flex items-center justify-center text-lg">${icon}</div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-1 flex-wrap">
                            <h3 class="font-bold text-gray-800 truncate text-sm">${p.cn_name || p.name}</h3>
                            ${p.featured ? '<span class="bg-amber-400 text-white text-xs px-1 rounded">ç²¾é€‰</span>' : ''}
                            ${isHot ? '<span class="bg-red-400 text-white text-xs px-1 rounded">çƒ­é—¨</span>' : ''}
                        </div>
                        <p class="text-xs text-gray-400">v${p.version} Â· <span onclick="event.stopPropagation(); filterByAuthor('${p.author}')" class="cursor-pointer hover:text-purple-500 hover:underline">${p.author}</span></p>
                    </div>
                </div>
                <p class="text-gray-600 text-xs mb-2 line-clamp-2">${p.description}</p>
                <div class="flex items-center justify-between">
                    <span class="px-2 py-0.5 rounded-full bg-purple-50 text-purple-600 text-xs">${p.category}</span>
                    <div class="flex items-center gap-2 text-xs text-gray-400">
                        <span>â¬‡ï¸${p.downloads || 0}</span>
                        <span class="flex items-center gap-0.5">
                            <span class="text-amber-400">â˜…</span>${(p.rating || 5).toFixed(1)}
                        </span>
                    </div>
                </div>
            </div>`;
        }
        
        function showDetail(id) {
            currentPlugin = plugins.find(p => p.id === id);
            if (!currentPlugin) return;
            
            // æ ‡è®°ä¸ºå·²æŸ¥çœ‹æ­¤ç‰ˆæœ¬ï¼ŒNEWæ ‡ç­¾ä¼šæ¶ˆå¤±
            markAsViewed(currentPlugin.id, currentPlugin.version);
            
            const icon = icons[currentPlugin.category] || 'ğŸ“¦';
            const isNew = false;  // å·²ç»æŸ¥çœ‹äº†ï¼Œä¸å†æ˜¾ç¤ºNEW
            const isHot = (currentPlugin.downloads || 0) >= 100;
            
            // å¤´éƒ¨
            let headerHtml = `
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-purple-100 to-pink-100 flex items-center justify-center text-3xl">${icon}</div>
                    <div class="flex-1">
                        <div class="flex items-center gap-2 flex-wrap">
                            <h2 class="text-xl font-bold text-gray-800">${currentPlugin.cn_name || currentPlugin.name}</h2>
                            ${currentPlugin.featured ? '<span class="bg-amber-400 text-white text-xs px-2 py-0.5 rounded-full">â­ ç²¾é€‰</span>' : ''}
                            ${isNew ? '<span class="bg-blue-500 text-white text-xs px-2 py-0.5 rounded-full">âœ¨ æ–°å“</span>' : ''}
                            ${isHot ? '<span class="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full">ğŸ”¥ çƒ­é—¨</span>' : ''}
                        </div>
                        <p class="text-gray-500 text-sm mt-1">
                            <span>ğŸ“¦ v${currentPlugin.version}</span>
                            <span class="mx-2">Â·</span>
                            <span>ğŸ‘¤ ${currentPlugin.author}</span>
                            <span class="mx-2">Â·</span>
                            <span>â¬‡ï¸ ${currentPlugin.downloads || 0}æ¬¡ä¸‹è½½</span>
                        </p>
                    </div>
                </div>`;
            document.getElementById('modalHeader').innerHTML = headerHtml;
            
            // å†…å®¹
            let bodyHtml = '<div class="space-y-4">';
            
            // è¯„åˆ†åŒºåŸŸ
            const myRating = getMyRating(currentPlugin.id);
            bodyHtml += `
                <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-4 rounded-xl">
                    <div class="flex items-center justify-between flex-wrap gap-2">
                        <div class="flex items-center gap-3">
                            <span class="text-sm text-gray-600">ç¤¾åŒºè¯„åˆ†:</span>
                            <div class="flex items-center gap-1">
                                ${renderStars(currentPlugin.rating || 5, false, currentPlugin.id)}
                                <span class="text-sm font-bold text-amber-600 ml-1">${(currentPlugin.rating || 5).toFixed(1)}</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-sm text-gray-600">æˆ‘çš„è¯„åˆ†:</span>
                            <div class="flex items-center gap-1">
                                ${renderStars(myRating || currentPlugin.rating || 5, true, currentPlugin.id)}
                                ${myRating ? `<span class="text-xs text-gray-400 ml-1">(${myRating}åˆ†)</span>` : '<span class="text-xs text-gray-400 ml-1">ç‚¹å‡»è¯„åˆ†</span>'}
                            </div>
                        </div>
                    </div>
                </div>`;
            
            // æˆªå›¾
            if (currentPlugin.screenshots?.length > 0) {
                bodyHtml += `
                    <div>
                        <h3 class="font-bold text-gray-700 mb-2 text-sm flex items-center gap-2">
                            ğŸ“¸ æ•ˆæœæˆªå›¾ <span class="text-xs text-gray-400 font-normal">ç‚¹å‡»æ”¾å¤§</span>
                        </h3>
                        <div class="screenshot-grid">
                            ${currentPlugin.screenshots.map(s => `
                                <div class="screenshot-item" onclick="event.stopPropagation(); showScreenshot('${s}')">
                                    <img src="${s}" alt="æˆªå›¾" onerror="this.parentElement.innerHTML='<div class=\\'flex items-center justify-center h-full bg-gray-100 text-gray-400 text-xs\\'>åŠ è½½å¤±è´¥</div>'">
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
            }
            
            // ä»‹ç»
            bodyHtml += `
                <div>
                    <h3 class="font-bold text-gray-700 mb-2 text-sm">ğŸ“ æ’ä»¶ä»‹ç»</h3>
                    <p class="text-gray-600 bg-gray-50 p-3 rounded-lg text-sm leading-relaxed">${currentPlugin.full_description || currentPlugin.description}</p>
                </div>`;
            
            // åŠŸèƒ½ç‰¹è‰²
            if (currentPlugin.features?.length) {
                bodyHtml += `
                    <div>
                        <h3 class="font-bold text-gray-700 mb-2 text-sm">âœ¨ åŠŸèƒ½ç‰¹è‰²</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            ${currentPlugin.features.map(f => `
                                <div class="flex items-center gap-2 text-gray-600 bg-green-50 px-3 py-2 rounded-lg text-sm">
                                    <span class="text-green-500">âœ“</span>
                                    <span>${f}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
            }
            
            // å‘½ä»¤
            if (currentPlugin.commands?.length) {
                bodyHtml += `
                    <div>
                        <h3 class="font-bold text-gray-700 mb-2 text-sm">âŒ¨ï¸ è§¦å‘å‘½ä»¤</h3>
                        <div class="flex flex-wrap gap-2">
                            ${currentPlugin.commands.map(c => `<code class="bg-purple-50 text-purple-600 px-3 py-1 rounded-lg text-sm">${c}</code>`).join('')}
                        </div>
                    </div>`;
            }
            
            // ä½¿ç”¨è¯´æ˜
            if (currentPlugin.usage) {
                bodyHtml += `
                    <div>
                        <h3 class="font-bold text-gray-700 mb-2 text-sm">ğŸ’¡ ä½¿ç”¨è¯´æ˜</h3>
                        <p class="text-gray-600 bg-blue-50 p-3 rounded-lg text-sm">${currentPlugin.usage}</p>
                    </div>`;
            }
            
            // æ›´æ–°æ—¥å¿—
            if (currentPlugin.changelog) {
                bodyHtml += `
                    <div>
                        <h3 class="font-bold text-gray-700 mb-2 text-sm">ğŸ“‹ æ›´æ–°æ—¥å¿—</h3>
                        <p class="text-gray-600 bg-gray-50 p-3 rounded-lg text-sm">${currentPlugin.changelog}</p>
                    </div>`;
            }
            
            // æ³¨æ„äº‹é¡¹
            if (currentPlugin.notes) {
                bodyHtml += `
                    <div>
                        <h3 class="font-bold text-gray-700 mb-2 text-sm">âš ï¸ æ³¨æ„äº‹é¡¹</h3>
                        <p class="text-gray-600 bg-amber-50 p-3 rounded-lg text-sm">${currentPlugin.notes}</p>
                    </div>`;
            }
            
            bodyHtml += '</div>';
            document.getElementById('modalBody').innerHTML = bodyHtml;
            document.getElementById('modalGithub').href = GITHUB_REPO + currentPlugin.id;
            document.getElementById('modal').classList.remove('hidden');
        }
        
        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
            currentPlugin = null;
            // åˆ·æ–°åˆ—è¡¨ï¼Œä½¿NEWæ ‡ç­¾æ¶ˆå¤±
            render();
            renderFeatured();
        }
        
        function installPlugin() {
            if (currentPlugin) window.open(LOCAL_URL + '/plugins/market?install=' + currentPlugin.id, '_blank');
        }
        
        function goLocal() {
            window.open(LOCAL_URL + '/plugins/market', '_blank');
        }
        
        // é”®ç›˜äº‹ä»¶
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closeScreenshot();
            }
        });
        
        document.getElementById('searchInput')?.addEventListener('input', render);
        
        init();
    </script>
</body>
</html>
